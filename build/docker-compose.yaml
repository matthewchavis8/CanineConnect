version: "3.8"

services:
  # Gets dependencies such as the SDK
  app-setup:
    image: mcr.microsoft.com/dotnet/sdk:7.0
    container_name: maui_app_setup
    working_dir: /src
    volumes:
      - ./src:/src
    command: >
      bash -c "if [ ! -f CanineConnect.csproj ]; then
        dotnet new maui -n CanineConnect -lang C# -o .;
      fi"
  app-builder:
    image: mcr.microsoft.com/dotnet/sdk:7.0
    container_name: maui_app_builder
    depends_on:
      - app-setup
    working_dir: /src
    volumes:
      - ./src:/src
      - ./publish:/app/publish
    command: >
      bash -c "dotnet publish CanineConnect.csproj \
        -c Release -f net7.0 -r linux-x64 \
        --self-contained false \
        -o /app/publish"

  # Displays CanineConnect
  app-runner:
    image: mcr.microsoft.com/dotnet/runtime:7.0
    container_name: maui_app_runner
    depends_on:
      - app-builder
    working_dir: /app
    volumes:
      - ./publish:/app
      - /tmp/.X11-unix:/tmp/.X11-unix
    environment:
      - DISPLAY=${DISPLAY}
    network_mode: host
    entrypoint: >
      bash -lc "apt-get update && \
                apt-get install -y libgtk-3-0 libwebkit2gtk-4.0-37 && \
                exec dotnet /app/CanineConnect.dll"
